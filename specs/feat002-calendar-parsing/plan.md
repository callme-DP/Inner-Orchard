# 计划（FEAT-002-日历解析修复）

## 步骤
1) 保留原始输出：调用 icalBuddy，保存 `data/calendar/raw/week-<ISO周>.txt`。
2) 小范围验证：新增 `--sample-day` 仅解析指定日，快速迭代正则。
3) 宽松解析：截断 `@url/notes:`，支持 yesterday/today/绝对日期时间段；解析失败行写日志。
4) 过滤策略：白名单过滤，若过滤后为空则保留全部并记录。
5) 全量生成：去掉 sample-day，生成 `week-<ISO周>.json`，验证 count 与原始行数匹配度。
6) 年度归档：聚合 `week-*.json` 到 `artifacts/calendar/all-<year>.json`（全年扁平数组，支持分片，去重并输出人工复核报告）。

## 设计
- 归档使用：`artifacts/calendar/all-<year>.json` 作为只读源，按时间窗口过滤渲染，不做增量写回；如需更新数据再手动全量重跑。
- 时间窗口：日视图按日期过滤，周视图按周起止或 ISO 周过滤；对比视图用两个窗口（本周 vs 上周/本日 vs 昨日）各自聚合后再对比。
- 渲染方式：优先保持单页静态 HTML，内嵌 JS 读取归档并做前端过滤/聚合；如交互复杂再考虑 Vite/构建链路。
- 视图交互：顶部 4 按钮切换日/周/月/年，所有卡片联动；总计卡展示应用/日历类别耗时及上一周期对比；突发任务卡固定按周展示“突发任务”日历的日粒度折线，对比上一周；精力趋势默认显示 4 维度本周，单选某维度时叠加上一周对比（mock 数据占位）。
- 去重报告：按 `title+start+end` 生成 `artifacts/calendar/dedup-review.md`，相邻周同日的重复不再提示，主要提示同周内的潜在重复供人工确认。
- 存储分片：年度扁平数组，若体积超限按 `all-<year>-1..9.json` 分片；默认先用全年单文件。
- 多源扩展：未来联动 Reminders/任务列表，保持字段兼容；待办：调研接入 ActivityWatch/Mood，统一时间/情绪轨迹。

## 验证
- 在本机运行 sample-day，检查日志 `[skip]` 占比；解析正常后全量生成。
- 记录解析成功/失败行数到日志，手动 spot check。

## 方案思路：ICS 预导出 + LangChain Agent
- 目的：在不依赖沙盒权限的前提下，保留完整日历数据并提供可调用的智能查询/修复路径，减少重复授权与人工介入。
- 功能：① 预导出或定时导出 `.ics`，用现成库（Python `icalendar`/`ics`）解析，保留 UID/提醒/时区，必要时最小映射到现有 JSON；② 视体积按月分片存档到 `artifacts/calendar/`，记录快照来源与生成时间；③ 封装 LangChain Agent 工具读取归档/解析结果，支持时间段聚合、冲突检查等，只读本地、落盘日志到 `artifacts/agent-results/`。
- 解决的当下问题：降低每次运行的 TCC 弹窗/权限阻塞；当解析失败或格式异常时，可切换到 Agent 方案（使用归档或自动修复字段），并在遇到此类问题时提示你确认是否启用。
